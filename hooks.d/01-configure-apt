#!/bin/bash
# 20-configure-apt
#
# This script configure apt
#

info " Starting: Configure APT "

#
# Setup the sources.list file for new installations of Debian GNU/Linux.
#

# disable apt sources.list base
sed -i 's/^deb/#deb/' /etc/apt/sources.list

# erase all .list repositories
rm -f /etc/apt/sources.list.d/*.list

# generate new repositories
if [ "$REPO_TYPE" == "local" ]; then
mirror="file://$REPO_URL/debian/"
else
mirror="http://$REPO_URL/debian/"
fi

# oficial repositories
cat <<E_O_APT > /etc/apt/sources.list.d/$SUITE.list
# oficial
deb $mirror $SUITE $REPO_SECTIONS
E_O_APT

# backport repositories
cat <<E_O_APT > /etc/apt/sources.list.d/backports.list
deb $mirror $SUITE-backports $REPO_SECTIONS
E_O_APT

if [ "$APT_SECURITY" == "yes" ]; then
# security and update repositories
cat <<E_O_APT > /etc/apt/sources.list.d/security.list
# updates
deb $mirror $SUITE-updates main
# security
deb http://security.debian.org/ $SUITE/updates main
E_O_APT
fi

cat <<EOF > /etc/apt/apt.conf.d/80-update
Acquire::Check-Valid-Until "false";
EOF

cat <<EOF > /etc/apt/preferences.d/$SUITE.pref
Package: *
Pin: release n=$SUITE
Pin-Priority: 100

Package: *
Pin: release n=$SUITE-updates
Pin-Priority: 999

EOF

if [ "$ENABLE_BACKPORTS" == "yes" ]; then
cat <<EOF >> /etc/apt/preferences.d/$SUITE.pref
Package: *
Pin: release n=$SUITE-backports
Pin-Priority: 999
EOF
fi

cat <<EOF > /etc/apt/apt.conf.d/10-$DIST
Acquire::PDiffs "false";
APT::Default-Release "stable"
// Acquire::Language "none";
APT::Clean-Installed "true";
APT::Get:AutomaticRemove "true";
APT::Get::HideAutoRemove "false";
APT::Get:Show-Upgraded "true";
EOF

if [ "$APT_RECOMMENDS" == "yes" ]; then
cat <<EOF > /etc/apt/apt.conf.d/90-recommends
APT::Install-Recommends "true";
EOF
fi

#
#  Now that the sources have been setup make sure the system is up to date.
#
debug "updating APT database"
$APT update

# install keyring list
debug "install Debian keyrings"
$APT -y install $KEYRINGS
	
# update and upgrade system
debug "upgrade system"
$APT upgrade -y
aptitude -y full-upgrade

# install test
if [ -z $(which lsb_release) ]; then
	echo "arepalinux warning: lsb-release is required"
	$APT -y install lsb-release
fi

if [ -z $(which lshw) ]; then
	echo "arepalinux warning: lshw is required"
	$APT -y install lshw
fi


if [[ "$MODE" = "workstation" || "$MODE" = "desktop" ]]; then
	if [ "$ENABLE_BACKPORTS" == "yes" ]; then
	# upgrade kernel from backports
		# install kernel kbuild for backports
		aptitude -y -t $SUITE-backports install $(aptitude -t $SUITE-backports search -F "%p" -O version linux-kbuild | tail -n1)
		aptitude -y -t $SUITE-backports install initramfs-tools
		# latest RT_PREEMPT Kernel from backports:
		aptitude -y -t $SUITE-backports --with-recommends install $(aptitude -t $SUITE-backports search -F "%p" -O version,name linux-image | grep -F "rt" | grep -Fv "dbg" | tail -n1) $(aptitude -t $SUITE-backports search -F "%p" -O version,name linux-headers | grep -F "rt" | grep -Fv "dbg" | tail -n1)
		# install latest firmware
		aptitude -y -t $SUITE-backports --without-recommends install firmware-linux-nonfree firmware-linux-free $(aptitude -t $SUITE-backports search firmware- | grep "^i " | awk '{ print $2}')
	else
		# upgrade to latest kernel
		aptitude -y -t $SUITE --with-recommends install $(aptitude -t $SUITE search -F "%p" -O version linux-image | grep -Fv "\-dbg" | tail -n1) $(aptitude -t $SUITE search -F "%p" -O version linux-headers | grep -Fv "\-dbg" | tail -n1)
	fi
fi
