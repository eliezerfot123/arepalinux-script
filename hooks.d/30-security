#!/bin/bash
# 30-security
#
#  Ensure all security software (fail2ban, psad, rkhunter) is installed and configured
#  in this system
#

info " Secure System "

# set expiration date for common user
chage -M 365 $ACCOUNT
chage -M 768 root

# remover suid bit a "su"
chmod -s /bin/su

# y a passwd
chmod -s /usr/bin/passwd
chmod -s /usr/bin/wall

# asegurar archivos basicos:
chmod 0754 /etc/profile /etc/login.defs /etc/init.d/rc

echo 'root' > /etc/ftpusers
echo 'nobody' >> /etc/ftpusers

# change default UMASK
sed -i -e 's/^UMASK.*$/UMASK          027/' /etc/login.defs
sed -i -e 's/^umask.*$/umask 027/' /etc/init.d/rc

# secure tmp
if [ -z "`grep 'secure tmp' /etc/fstab`" ]; then
cat <<EOF >> /etc/fstab
# secure tmp
tmpfs /tmp tmpfs nosuid,nodev,rw 0 0
EOF
fi

if [ -z "`grep -F 'legal information:' /etc/motd`" ]; then
echo "legal information:" >> /etc/motd
echo "This is a private system, all unauthorized access is prohibited" >> /etc/motd 
fi

if [ -z "`grep -F 'legal information:' /etc/issue.net`" ]; then
echo "legal information:" >> /etc/issue.net
echo "This is a private system, all unauthorized access is prohibited" >> /etc/issue.net
fi

if [ -z "`grep -F 'legal information:' /etc/issue`" ]; then
echo "hostname:  \n tty: \l " >> /etc/issue
echo "legal information:" >> /etc/issue
echo "This is a private system, all unauthorized access is prohibited" >> /etc/issue
fi

# Passwords expire every 180 days
perl -npe 's/PASS_MAX_DAYS\s+99999/PASS_MAX_DAYS 180/' -i /etc/login.defs

# Passwords may only be changed once a day
perl -npe 's/PASS_MIN_DAYS\s+0/PASS_MIN_DAYS 1/g' -i /etc/login.defs

# Login retries change to 6
perl -npe 's/LOGIN_RETRIES\s+5/LOGIN_RETRIES 6/g' -i /etc/login.defs

# kick off idle users:
message "Idle users will be removed after 15 minutes"
cat <<EOF > /etc/profile.d/os-security.sh
# set a 15 min timeout policy for bash shell
readonly TMOUT=900
export TMOUT
EOF
chmod +x /etc/profile.d/os-security.sh
